"use strict";var te=Object.create;var b=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var ie=(n,e)=>{for(var r in e)b(n,r,{get:e[r],enumerable:!0})},j=(n,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of re(e))!se.call(n,o)&&o!==r&&b(n,o,{get:()=>e[o],enumerable:!(t=ne(e,o))||t.enumerable});return n};var k=(n,e,r)=>(r=n!=null?te(oe(n)):{},j(e||!n||!n.__esModule?b(r,"default",{value:n,enumerable:!0}):r,n)),ae=n=>j(b({},"__esModule",{value:!0}),n);var Pe={};ie(Pe,{AuthorizationType:()=>J,Basekit:()=>P,Component:()=>B,DateFormatter:()=>Q,FieldCode:()=>Z,FieldComponent:()=>G,FieldComponentEnum:()=>q,FieldType:()=>v,NextStep:()=>W,NumberFormatter:()=>K,ParamType:()=>N,StructureType:()=>$,TriggerType:()=>V,base:()=>me,basekit:()=>S,bitable:()=>ue,createActionContext:()=>ke,createFetch:()=>X,createFieldContext:()=>Ae,execute:()=>ye,field:()=>le,generateOptions:()=>be,getBasekitUrl:()=>Ie,newPack:()=>ge,t:()=>xe,testAction:()=>Y,testActionAutocomplete:()=>fe,testField:()=>he,uploadAttachments:()=>Te});module.exports=ae(Pe);var y=k(require("node-fetch")),A=k(require("path")),D=k(require("fs")),C=k(require("form-data")),H=k(require("mime"));var ce={string:n=>typeof n=="string",number:n=>typeof n=="number",object:n=>typeof n=="object"&&n!==null&&!Array.isArray(n),array:n=>Array.isArray(n),boolean:n=>typeof n=="boolean",link:n=>{if(typeof n!="string")throw new Error("result is not a string");if(!/^(?:(?:https?|ftp):\/\/)?[\w/\-?=%.]+\.[\w/\-?=%.]+$/.test(n))throw new Error("result is not a valid link");return!0},timestamp:n=>typeof n!="string"||typeof n!="number"||isNaN(n)?!1:!!/^(\d{10}|\d{13})$/.test(String(n)),null:n=>n===null},pe=new Proxy(ce,{get(n,e){return r=>{if(r===void 0)return!0;let t=Reflect.get(n,e);if(t===void 0)throw new Error(`Unknown property "${String(e)}"`);return t(r)}}});function w(n,e,r=[]){let t=e?.type,o=e&&"properties"in e?e.properties:void 0;r.length===0&&t!=="object"&&console.log("\x1B[31m The type field of the root node of resultType must be object.\x1B[0m");let c={errorDesc:{},propertyMissingDescInResultType:{},propertyMissingInResult:{}},a=Object.keys(n),g=Object.keys(o||{}),s=[],m=r.join(".")||"execute returned value";for(let p=0;p<a.length;p++){let u=a[p];g.includes(u)||s.push(u)}s.length&&(c.propertyMissingDescInResultType[m]=s);let h=[];for(let p=0;p<g.length;p++){let u=g[p];a.includes(u)||h.push(u)}return h.length&&(console.log(`
\x1B[31m Missing property\u300C${h.join(",")}\u300Din\u300C${m}\u300D\x1B[0m`),c.propertyMissingInResult[m]=h),a.forEach(p=>{let u=n[p],l=r.concat(p),f;if(e?.type==="object"&&(f=e.properties[p]),f&&typeof f=="object"){let d=f.type;pe[d](u)||(console.log(`
\x1B[31m The type of\u300C${l.join(".")}\u300Dshould be\u300C${d}\u300D \x1B[0m`),c.errorDesc[l.join(".")]={value:n[p],resultType:d})}if(typeof n[p]=="object"&&n[p]!==null){let d=w(n[p],o?.[p],l);c={errorDesc:{...d.errorDesc,...c.errorDesc},propertyMissingDescInResultType:{...d.propertyMissingDescInResultType,...c.propertyMissingDescInResultType},propertyMissingInResult:{...d.propertyMissingInResult,...c.propertyMissingInResult}}}}),c}var R=k(require("url")),v=(i=>(i[i.NotSupport=0]="NotSupport",i[i.Text=1]="Text",i[i.Number=2]="Number",i[i.SingleSelect=3]="SingleSelect",i[i.MultiSelect=4]="MultiSelect",i[i.DateTime=5]="DateTime",i[i.Checkbox=7]="Checkbox",i[i.User=11]="User",i[i.Phone=13]="Phone",i[i.Url=15]="Url",i[i.Attachment=17]="Attachment",i[i.SingleLink=18]="SingleLink",i[i.Lookup=19]="Lookup",i[i.Formula=20]="Formula",i[i.DuplexLink=21]="DuplexLink",i[i.Location=22]="Location",i[i.GroupChat=23]="GroupChat",i[i.Stage=24]="Stage",i[i.Object=25]="Object",i[i.Denied=403]="Denied",i[i.CreatedTime=1001]="CreatedTime",i[i.ModifiedTime=1002]="ModifiedTime",i[i.CreatedUser=1003]="CreatedUser",i[i.ModifiedUser=1004]="ModifiedUser",i[i.AutoNumber=1005]="AutoNumber",i[i.VirtualTrigger=3001]="VirtualTrigger",i[i.Barcode=99001]="Barcode",i[i.Progress=99002]="Progress",i[i.Currency=99003]="Currency",i[i.Rating=99004]="Rating",i[i.Email=99005]="Email",i))(v||{}),N=(s=>(s.Null="null",s.Number="number",s.String="string",s.Boolean="boolean",s.Link="link",s.Timestamp="timestamp",s.Array="array",s.Object="object",s))(N||{}),B=(l=>(l.Input="TextEditor",l.DateTimePicker="DateTimeInput",l.ContactPicker="UserSelect",l.Collapse="Collapse",l.Checkbox="CheckboxInput",l.Tips="InfoTips",l.TableSelect="TableSelect",l.TableViewSelect="TableViewSelect",l.SingleSelect="SingleSelect",l.MultipleSelect="MultipleSelect",l.Attachment="AttachmentInput",l.Radio="Radio",l.KeyValuePair="KeyValuePair",l))(B||{}),q=(a=>(a.Input="TextEditor",a.SingleSelect="SingleSelect",a.MultipleSelect="MultipleSelect",a.Radio="Radio",a.TableSelect="TableSelect",a.FieldSelect="FieldSelect",a))(q||{}),$=(o=>(o.User="user",o.Group="group",o.Attachment="attachment",o.Options="options",o))($||{}),V=(a=>(a.AddRecord="AddRecordTrigger",a.SetRecord="SetRecordTrigger",a.ChangeRecord="ChangeRecordTrigger",a.Timer="TimerTrigger",a.Reminder="ReminderTrigger",a.Button="ButtonTrigger",a))(V||{}),W=(c=>(c.LarkMessage="LarkMessageAction",c.AddRecord="AddRecordAction",c.SetRecord="SetRecordAction",c.FindRecord="FindRecordAction",c.HTTPClient="HTTPClientAction",c))(W||{}),K=(m=>(m.INTEGER="0",m.DIGITAL_ROUNDED_1="0.0",m.DIGITAL_ROUNDED_2="0.00",m.DIGITAL_ROUNDED_3="0.000",m.DIGITAL_ROUNDED_4="0.0000",m.DIGITAL_THOUSANDS="1,000",m.DIGITAL_THOUSANDS_DECIMALS="1,000.00",m.PERCENTAGE_ROUNDED="0%",m.PERCENTAGE="0.00%",m))(K||{}),Q=(g=>(g.DATE_YMD_WITH_SLASH="yyyy/MM/dd",g.DATE_TIME="yyyy/MM/dd HH:mm",g.DATE_TIME_WITH_HYPHEN="yyyy-MM-dd HH:mm",g.DATE_YMD_WITH_HYPHEN="yyyy-MM-dd",g.DATE_MD_WITH_HYPHEN="MM-dd",g.DATE_MMDD_WITH_SLASH="MM/dd/yyyy",g.DATE_DDMM_WITH_SLASH="dd/MM/yyyy",g))(Q||{}),G=(a=>(a.SingleSelect="SingleSelect",a.Input="Text",a.Radio="Radio",a.FieldSelect="FieldSelect",a.MultipleSelect="MultipleSelect",a.TableSelect="TableSelect",a))(G||{}),Z=(s=>(s[s.Success=0]="Success",s[s.Error=1254500]="Error",s[s.ConfigError=1254400]="ConfigError",s[s.InvalidArgument=1254406]="InvalidArgument",s[s.AuthorizationError=1254403]="AuthorizationError",s[s.PayError=1254505]="PayError",s[s.RateLimit=1254404]="RateLimit",s[s.QuotaExhausted=1254405]="QuotaExhausted",s))(Z||{}),J=(s=>(s.HeaderBearerToken="HeaderBearerToken",s.Basic="Basic",s.CustomHeaderToken="CustomHeaderToken",s.MultiHeaderToken="MultiHeaderToken",s.QueryParamToken="QueryParamToken",s.MultiQueryParamToken="MultiQueryParamToken",s.Custom="Custom",s.OAuth2="OAuth2",s))(J||{}),P=class{addDomainList(e){this.domainList=e}addAction(e){this.action=e}addField(e){if(e.resultType.type===25){let{extra:r}=e.resultType,{properties:t}=r;t.forEach(o=>{if(o.title=o.label||o.title,!o.title)throw new Error(`resultType.extra.properties\u53C2\u6570\u5BF9\u8C61\u7F3A\u5C11label\u5C5E\u6027
The parameter object 'resultType. extra. properties' is missing the label attribute`)})}this.field=e}setI18n(e){this.i18n=e}},S=new P,le={t(n){return`\${{${n}}}`}},ue=S,me=S;function ge(){return S}function z(n){let e=process.cwd(),r,t=A.default.join(e,"src/register.ts"),o=A.default.join(e,"src/register.js");if(D.default.existsSync(t))r=t;else if(D.default.existsSync(o))r=o;else if(n==="field")r=A.default.join(e,"src/index.ts");else throw new Error("Can not find src/register.ts file");let c=require(r);return c.default||c}async function Y(n,e){let r=z(),t=r.action?.resultType,o=await r?.action?.execute(n,e);return w(o,t),console.log(o),o}function de(n,e){n.code===0&&e.type===25&&e.extra.properties.forEach(r=>{let{key:t}=r;if(!(typeof n.data=="object"&&Object.prototype.hasOwnProperty.call(n.data,t)))throw new Error(`Miss [${t}] in execute return value but declare in resultType`)})}async function he(n,e){let r=z("field"),t=X(r.field?.authorizations??[],r.domainList??[]),o=r.field?.resultType,c=await r?.field?.execute(n,{...e,fetch:t});return de(c,o),console.log(c),c}async function fe(n,e,r){let t=z(),{itemId:o}=r,c=t.action?.formItems?.find(a=>a.itemId===o);if(typeof c?.autocomplete=="function"){let a=c.autocomplete,g=await a(n,e,r);console.log(g)}else console.error(`Can not find autocomplete function in formItem with itemId ${o}`)}var ye=Y;async function Ae(n){return Object.assign({logID:"",timeZone:"",tenantKey:"",fetch:y.default},n)}async function ke(n){let e=process.cwd(),{appId:r}=require(A.default.join(e,"../app.json")),{blockTypeID:t}=require(A.default.join(e,"block.json"));return Object.assign({app:{token:"",logID:"",trigger:{type:"AddRecordTrigger"}},packID:r,extensionID:t,fetch:y.default,tenantAccessToken:"",tenantKey:""},n)}function xe(n,e){let r=`<%${n}%>`;if(e){let t=Object.keys(e).reduce((o,c)=>{let a=e[c];return a.type==="icon"?o[c]=Object.assign(a,{url:a.src}):o[c]=a,o},{});return{text:r,param:t}}return r}async function Te(n,e){let{context:r}=e,{tenantAccessToken:t}=r;if(!(r.app||r.bitable)?.token)throw new Error("app.token is empty, please config it to context in test/index file");if(!t)throw new Error("tenantAccessToken is empty, please config it to context in test/index file");return new M(n,e).upload()}var M=class{constructor(e,r){this.CHUNK_SIZE=4*1024*1024;this.SEQ_SIZE=20*1024*1024;this.maxRetries=10;this.options=r,this.attachments=e;let{tenantAccessToken:t}=r.context,o=`Bearer ${t}`;this.Authorization=o,typeof r.retry=="number"&&(this.maxRetries=r.retry)}async upload(){let{attachments:e,SEQ_SIZE:r}=this,t=[];for(let o=0;o<e.length;o++){let c=e[o],a=c.file.length>=r?await this.uploadLargeFile(c):await this.uploadFile(c);t.push(a)}return t}async uploadFile(e,r=0){let{options:t}=this,{context:o}=t,{fetch:c,tenantAccessToken:a}=o,s=(o.app||o.bitable)?.token,{name:m,file:h}=e,p=h.length,u=new C.default;u.append("file_name",m),u.append("parent_type","bitable_file"),u.append("parent_node",s),u.append("size",p),u.append("file",h);let l=u.getHeaders(),d=`https://${this.getDomain()}/open-apis/drive/v1/medias/upload_all`,T=await c(d,{method:"POST",headers:{Authorization:`Bearer ${a}`,...l},body:u}),O=T.headers.get("x-ogw-ratelimit-reset");if(O){if(r<this.maxRetries)return new Promise((F,ee)=>{let _=parseInt(O,10)*1e3;console.log(`Retrying in ${_} seconds.`),setTimeout(()=>{this.uploadFile(e,r+1).then(F).catch(ee)},_)});throw new Error(`Retrying 3 times failed. ${this.createMsg("Refer to the documentation to fix the error: https://open.feishu.cn/document/server-docs/api-call-guide/frequency-control","Refer to the documentation to fix the error: https://open.larksuite.com/document/server-docs/getting-started/frequency-control","Please try again later.")}`)}let E=await T.json(),L=E.data?.file_token;if(!L)throw console.warn("Upload file fail, you can check if your app is added to Base First"),new Error(this.createErrorMsg(E));return this.generateAttachment(e,L)}createMsg(e,r,t){let{env:o}=this.options;return o==="feishu"?e:o==="lark"?r:t}createErrorMsg(e){try{return JSON.stringify(e,void 0,2)}catch{return"Stringify upload result fail"}}generateAttachment(e,r){let t=e.mimeType||H.default.getType(e.name);if(!t)throw new Error("Can not parse the mineType from file name");return{id:r,attachmentToken:r,name:e.name,mimeType:t,size:e.file.length,timeStamp:Math.floor(Date.now()/1e3)}}getDomain(){let{env:e="feishu"}=this.options;return{feishu:"open.feishu.cn",lark:"open.larksuite.com"}[e]||e}async uploadLargeFile(e){let r=await this.uploadPrepare(e);await this.uploadChunks(e,r.upload_id);let t=await this.uploadFinish(r);return this.generateAttachment(e,t)}async uploadFinish(e){let{Authorization:r}=this,t=this.getDomain();return(await(0,y.default)(`https://${t}/open-apis/drive/v1/medias/upload_finish`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:r},body:JSON.stringify(e)}).then(c=>c.json())).data.file_token}async uploadPrepare(e){let{options:r,Authorization:t}=this,{name:o,file:c}=e,g=(r.context.app||r.context.bitable)?.token,s=JSON.stringify({file_name:o,parent_type:"bitable_file",parent_node:g,size:c.length}),m=this.getDomain();return(await(0,y.default)(`https://${m}/open-apis/drive/v1/medias/upload_prepare`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t},body:s}).then(p=>p.json())).data}async uploadChunks(e,r){let{CHUNK_SIZE:t}=this,{file:o}=e,c=Math.ceil(o.length/t),a=[];for(let g=0;g<c;g++){let s=await this.uploadChunk(e,g,r);a.push(s)}return a}async uploadChunk(e,r,t,o=0){let{Authorization:c,maxRetries:a,CHUNK_SIZE:g}=this,{file:s,name:m}=e,h=r*g,p=Math.min(h+g,s.length),u=s.slice(h,p),l=new C.default;l.append("upload_id",t),l.append("seq",r),l.append("size",p-h),l.append("file",u,m);let f=l.getHeaders();try{let d=this.getDomain();await(0,y.default)(`https://${d}/open-apis/drive/v1/medias/upload_part`,{method:"POST",headers:{Authorization:c,...f},body:l}).then(T=>T.json())}catch{if(o>=a)throw new Error(`Failed to upload chunk ${r} after ${a} retries`);return this.uploadChunk(e,r,t,o+1)}}};function be(n){return n.map(e=>({name:e}))}function Ie(n){let{tableId:e,viewId:r,recordId:t,fieldId:o}=n;if(!e||!r||!n.url)throw new Error("\u300C tableId,viewId,url \u300D can not be empty");let c=new URL(n.url);return c.searchParams.set("table",e),c.searchParams.set("view",r),t&&c.searchParams.set("record",t),o&&c.searchParams.set("field",o),c.toString()}function x(n,e){let r=R.default.parse(n,!0);return delete r.search,Object.assign(r.query,e),R.default.format(r)}var U=process.cwd();function X(n,e){return async function(t,o,c){let a="";typeof t=="string"?a=t:typeof t.href=="string"?a=t.href:typeof t.url=="string"&&(a=t.url);let g=Re(a);if(!e?.some(m=>g.endsWith(m)))throw new Error(`${a} is not in request whitelist, please config the domainList`);let s=Array.isArray(n)&&n.find(m=>m.id===c);if(s){let m=n?.findIndex(u=>u.id===c),h=require(A.default.join(U,"config.json"));if(!h)throw new Error(`Miss config.json file in ${U}`);if(!h.authorizations?.[m])throw new Error("Miss authorizations in config.json");o||(o={});let p=h.authorizations[m];switch(s.type){case"Basic":{if(!p.username)throw new Error(`Miss authorizations[${m}.]username in config.json`);if(!p.password)throw new Error(`Miss authorizations[${m}.]password in config.json`);let l=Buffer.from(`${p.username}:${p.password}`,"utf-8").toString("base64");o={...o,headers:{...o.headers,Authorization:`Basic ${l}`}};break}case"HeaderBearerToken":{o={...o,headers:{...o.headers,Authorization:`Bearer ${p}`}};break}case"OAuth2":{o={...o,headers:{...o.headers,Authorization:`Bearer ${p}`}};break}case"CustomHeaderToken":{s.params?.headerName&&(o={...o,headers:{...o.headers,[s.params.headerName]:p}});break}case"MultiHeaderToken":{if(Array.isArray(s.params)&&s.params.length>0){let u=s.params.reduce((l,f,d)=>(l[f.key]=p?.[d],l),{});o={...o,headers:{...o.headers,...u}}}break}case"QueryParamToken":{s.params?.paramName&&(typeof t=="string"?t=x(t,{[s.params.paramName]:encodeURIComponent(p)}):typeof t.href=="string"?t.href=x(t.href,{[s.params.paramName]:encodeURIComponent(p)}):typeof t.url=="string"&&(t.url=x(t.url,{[s.params.paramName]:encodeURIComponent(p)})));break}case"MultiQueryParamToken":{if(Array.isArray(s.params)&&s.params.length>0){let u=s.params.reduce((l,f,d)=>(l[f.key]=encodeURIComponent(p?.[d]),l),{});typeof t=="string"?t=x(t,u):typeof t.href=="string"?t.href=x(t.href,u):typeof t.url=="string"&&(t.url=x(t.url,u))}break}case"Custom":{if(Array.isArray(s.params)&&s.params.length>0){let u=s.params.reduce((l,f,d)=>(l[f.key]=encodeURIComponent(p?.[d]),l),{});typeof t=="string"?t=I(t,u):typeof t.href=="string"?t.href=I(t.href,u):typeof t.url=="string"&&(t.url=I(t.url,u)),typeof o?.body=="string"&&(o.body=I(o.body,u))}break}}}return(0,y.default)(t,o)}}function I(n,e){return n.replace(/{{\s*(\S+?)\s*}}/g,(t,o)=>e[o]??t)}function Re(n){return R.default.parse(n).hostname??n}0&&(module.exports={AuthorizationType,Basekit,Component,DateFormatter,FieldCode,FieldComponent,FieldComponentEnum,FieldType,NextStep,NumberFormatter,ParamType,StructureType,TriggerType,base,basekit,bitable,createActionContext,createFetch,createFieldContext,execute,field,generateOptions,getBasekitUrl,newPack,t,testAction,testActionAutocomplete,testField,uploadAttachments});
